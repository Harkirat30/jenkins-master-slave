pipeline {
    agent {
        kubernetes {
            cloud 'jenkins-gke'
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent-harkirat
spec:
  serviceAccountName: jenkins-sa
  containers:
  - name: jnlp
    image: us-central1-docker.pkg.dev/pod-x-harkirat-singh/jenkins/jenkins-slave:v5
    args: ['\$(JENKINS_SECRET)', '\$(JENKINS_NAME)']
    volumeMounts:
    - name: docker-socket
      mountPath: /var/run/docker.sock
    - name: gcloud-config
      mountPath: /root/.config
  volumes:
  - name: docker-socket
    hostPath:
      path: /var/run/docker.sock
      type: Socket
  - name: gcloud-config
    emptyDir: {}
"""
        }
    }
    environment {
        ZONE = "us-central1-a"
        PROJECT_ID = "pod-x-harkirat-singh"
    }

    stages{
        
        stage('Checkout') {
            steps {
                // Checkout code from the public Git repository
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/main']],  // Replace 'main' with your branch name
                          userRemoteConfigs: [[url: 'https://github.com/Harkirat30/jenkins-master-slave.git']]])
                          
            }
        }
                stage("Building Application Docker Image"){
            steps{
                script{
                    sh 'gcloud auth configure-docker us-central1-docker.pkg.dev'
                    sh 'docker build . -t us-central1-docker.pkg.dev/pod-x-harkirat-singh/jenkins/hello-app:${BUILD_NUMBER}'
                    }
                }
            }
        stage("Pushing Application Docker Image to Google Artifact Registry"){
            steps{
                script{
                    sh 'docker push us-central1-docker.pkg.dev/pod-x-harkirat-singh/jenkins/hello-app:${BUILD_NUMBER}'
        }}}
        stage("Application Deployment on Google Kubernetes Engine"){
            steps{
                script{
                    sh 'sed -i "s|${batman}:${BUILD_NUMBER}|g" deployment.yaml'
                    sh "gcloud container clusters get-credentials primary --zone ${env.ZONE} --project ${env.PROJECT_ID}"
                    sh 'kubectl apply -f deployment.yaml'
                    sh 'kubectl apply -f service.yaml'
                }
            }
        }
        stage("Update deployment file again"){
            steps{
                script{
                    sh 'sed -i "s|${BUILD_NUMBER}:${batman}|g" deployment.yaml'
                }
            } 
        }
    }
    }
